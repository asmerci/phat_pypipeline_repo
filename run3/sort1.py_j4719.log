Run Sorting Function
Sort: <wpipe.DataProduct.DataProduct object at 0x7fdc569afc88>
['iepu21dbq_flc.fits', '16799', 'M31-B33-F06-UVIS', '16799_M31-B33-F06-UVIS']
['iepu21ddq_flc.fits', '16799', 'M31-B33-F06-UVIS', '16799_M31-B33-F06-UVIS']
['iepu21dhq_flc.fits', '16799', 'M31-B33-F06-UVIS', '16799_M31-B33-F06-UVIS']
['iepu21dlq_flc.fits', '16799', 'M31-B33-F06-UVIS', '16799_M31-B33-F06-UVIS']
['iepu22dqq_flc.fits', '16799', 'M31-B33-F07-UVIS', '16799_M31-B33-F07-UVIS']
['iepu22dvq_flc.fits', '16799', 'M31-B33-F07-UVIS', '16799_M31-B33-F07-UVIS']
['iepu22dzq_flc.fits', '16799', 'M31-B33-F07-UVIS', '16799_M31-B33-F07-UVIS']
['iepu22e4q_flc.fits', '16799', 'M31-B33-F07-UVIS', '16799_M31-B33-F07-UVIS']
FINAL_DF, # 8
             FILENAME PROPOSID          TARGNAME       PROPOSID_TARGNAME
0  iepu21dbq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
1  iepu21ddq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
2  iepu21dhq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
3  iepu21dlq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
4  iepu22dqq_flc.fits    16799  M31-B33-F07-UVIS  16799_M31-B33-F07-UVIS
5  iepu22dvq_flc.fits    16799  M31-B33-F07-UVIS  16799_M31-B33-F07-UVIS
6  iepu22dzq_flc.fits    16799  M31-B33-F07-UVIS  16799_M31-B33-F07-UVIS
7  iepu22e4q_flc.fits    16799  M31-B33-F07-UVIS  16799_M31-B33-F07-UVIS
['16799_M31-B33-F06-UVIS', '16799_M31-B33-F07-UVIS']
16799_M31-B33-F06-UVIS DataFrame
             FILENAME PROPOSID          TARGNAME       PROPOSID_TARGNAME
0  iepu21dbq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
1  iepu21ddq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
2  iepu21dhq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
3  iepu21dlq_flc.fits    16799  M31-B33-F06-UVIS  16799_M31-B33-F06-UVIS
['iepu21dbq_flc.fits', 'iepu21ddq_flc.fits', 'iepu21dhq_flc.fits', 'iepu21dlq_flc.fits']
Traceback (most recent call last):
  File "/Users/mmckay/phd_projects/phat_pipeline_dev/phat_pypipeline_repo/run3/build/sort1.py", line 129, in <module>
    my_target = my_input.target(name=target_name, rawdps_to_add=rawdp_fn_list[0])
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Input.py", line 349, in target
    return Target(self, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 290, in wrapper
    for session in si.begin_session(**local_kw):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 202, in begin_session
    wait=tn.wait_random()):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 382, in __iter__
    do = self.iter(retry_state=retry_state)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 349, in iter
    return fut.result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 425, in result
    return self.__get_result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 384, in __get_result
    raise self._exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 181, in retrying_session
    yield session
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 307, in wrapper
    output = func(self_cls, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Target.py", line 199, in __init__
    self.configure_target(rawdps_to_add=kwargs.get('rawdps_to_add', None))
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Target.py", line 348, in configure_target
    parameters=json.load(open(confdp.relativepath+'/'+confdp.filename))[0], **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Target.py", line 339, in configuration
    return Configuration(self, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Configuration.py", line 220, in __new__
    for retry in session.retrying_nested():
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 382, in __iter__
    do = self.iter(retry_state=retry_state)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 349, in iter
    return fut.result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 425, in result
    return self.__get_result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 384, in __get_result
    raise self._exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Configuration.py", line 249, in __new__
    dpowner=cls._configuration, group='raw')
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/DataProduct.py", line 617, in symlink
    return self._copy_symlink(path, kwargs, func=os.symlink)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/DataProduct.py", line 568, in _copy_symlink
    func(self.path, path + '/' + filename)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/DataProduct.py", line 348, in path
    return self.relativepath + '/' + self.filename
TypeError: unsupported operand type(s) for +: 'NoneType' and 'str'
Error in atexit._run_exitfuncs:
Traceback (most recent call last):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1820, in _execute_context
    cursor, statement, parameters, context
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/default.py", line 732, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/cursors.py", line 148, in execute
    result = self._query(query)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/cursors.py", line 310, in _query
    conn.query(q)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 548, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 775, in _read_query_result
    result.read()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 1156, in read
    first_packet = self.connection._read_packet()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 725, in _read_packet
    packet.raise_for_error()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/protocol.py", line 221, in raise_for_error
    err.raise_mysql_exception(self._data)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/err.py", line 143, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.IntegrityError: (1452, 'Cannot add or update a child row: a foreign key constraint fails (`wpipe`.`dataproducts`, CONSTRAINT `dataproducts_ibfk_2` FOREIGN KEY (`dpowner_id`) REFERENCES `dpowners` (`id`))')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 425, in result
    return self.__get_result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 384, in __get_result
    raise self._exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 181, in retrying_session
    yield session
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 307, in wrapper
    output = func(self_cls, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Job.py", line 627, in _ending_todo
    self.state = repr(sys.last_value)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 290, in wrapper
    for session in si.begin_session(**local_kw):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 202, in begin_session
    wait=tn.wait_random()):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 382, in __iter__
    do = self.iter(retry_state=retry_state)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 349, in iter
    return fut.result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 425, in result
    return self.__get_result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 384, in __get_result
    raise self._exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 181, in retrying_session
    yield session
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 307, in wrapper
    output = func(self_cls, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/Job.py", line 350, in state
    self.update_timestamp()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 290, in wrapper
    for session in si.begin_session(**local_kw):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 202, in begin_session
    wait=tn.wait_random()):
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 382, in __iter__
    do = self.iter(retry_state=retry_state)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/tenacity/__init__.py", line 349, in iter
    return fut.result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 425, in result
    return self.__get_result()
  File "/Users/mmckay/conda/lib/python3.6/concurrent/futures/_base.py", line 384, in __get_result
    raise self._exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 181, in retrying_session
    yield session
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/core.py", line 307, in wrapper
    output = func(self_cls, *args, **kwargs)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/OptOwner.py", line 95, in update_timestamp
    self._session.commit()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/wpipe/sqlintf/__init__.py", line 135, in commit
    self.SESSION.commit()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 1435, in commit
    self._transaction.commit(_to_root=self.future)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 829, in commit
    self._prepare_impl()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 808, in _prepare_impl
    self.session.flush()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 3367, in flush
    self._flush(objects)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 3507, in _flush
    transaction.rollback(_capture_exception=True)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/util/langhelpers.py", line 72, in __exit__
    with_traceback=exc_tb,
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/util/compat.py", line 207, in raise_
    raise exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/session.py", line 3467, in _flush
    flush_context.execute()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py", line 453, in execute
    n.execute_aggregate(self, set_)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/unitofwork.py", line 748, in execute_aggregate
    mapper, [self.state] + [r.state for r in our_recs], uow
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py", line 250, in save_obj
    insert,
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/orm/persistence.py", line 1098, in _emit_insert_statements
    statement, multiparams, execution_options=execution_options
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1631, in _execute_20
    return meth(self, args_10style, kwargs_10style, execution_options)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/sql/elements.py", line 326, in _execute_on_connection
    self, multiparams, params, execution_options
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1508, in _execute_clauseelement
    cache_hit=cache_hit,
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1863, in _execute_context
    e, statement, parameters, cursor, context
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 2044, in _handle_dbapi_exception
    sqlalchemy_exception, with_traceback=exc_info[2], from_=e
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/util/compat.py", line 207, in raise_
    raise exception
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/base.py", line 1820, in _execute_context
    cursor, statement, parameters, context
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/sqlalchemy/engine/default.py", line 732, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/cursors.py", line 148, in execute
    result = self._query(query)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/cursors.py", line 310, in _query
    conn.query(q)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 548, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 775, in _read_query_result
    result.read()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 1156, in read
    first_packet = self.connection._read_packet()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/connections.py", line 725, in _read_packet
    packet.raise_for_error()
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/protocol.py", line 221, in raise_for_error
    err.raise_mysql_exception(self._data)
  File "/Users/mmckay/venv/wings2/lib/python3.6/site-packages/pymysql/err.py", line 143, in raise_mysql_exception
    raise errorclass(errno, errval)
sqlalchemy.exc.IntegrityError: (pymysql.err.IntegrityError) (1452, 'Cannot add or update a child row: a foreign key constraint fails (`wpipe`.`dataproducts`, CONSTRAINT `dataproducts_ibfk_2` FOREIGN KEY (`dpowner_id`) REFERENCES `dpowners` (`id`))')
[SQL: INSERT INTO dataproducts (id, filename, relativepath, suffix, data_type, subtype, `group`, filtername, ra, `dec`, pointing_angle, dpowner_id) VALUES (%(id)s, %(filename)s, %(relativepath)s, %(suffix)s, %(data_type)s, %(subtype)s, %(group)s, %(filtername)s, %(ra)s, %(dec)s, %(pointing_angle)s, %(dpowner_id)s)]
[parameters: {'id': 4724, 'filename': 'iepu21dbq_flc.fits', 'relativepath': '/Users/mmckay/phd_projects/phat_pipeline_dev/phat_pypipeline_repo/run3/data/16799_M31-B33-F06-UVIS/raw_default', 'suffix': 'fits', 'data_type': '', 'subtype': '', 'group': 'raw', 'filtername': '', 'ra': 0.0, 'dec': 0.0, 'pointing_angle': 0.0, 'dpowner_id': 739}]
(Background on this error at: https://sqlalche.me/e/14/gkpj)
